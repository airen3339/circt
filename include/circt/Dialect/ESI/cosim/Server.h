//===- Server.h - ESI cosim RPC servers -------------------------*- C++ -*-===//
//
// Various classes used to implement the RPC server classes generated by
// CapnProto. Capnp C++ RPC servers are based on 'libkj' and its asyncrony
// model, which is very foreign.
//
//===----------------------------------------------------------------------===//

#include "EndPoint.h"
#include "circt/Dialect/ESI/cosim/CosimDpi.capnp.h"
#include <capnp/any.h>
#include <capnp/ez-rpc.h>
#include <iostream>
#include <kj/async.h>
#include <map>
#include <thread>

#ifndef __COSIM_DPI_SERVER_H__
#define __COSIM_DPI_SERVER_H__

namespace circt {
namespace esi {
namespace cosim {

/// Implements the `EsiDpiEndpoint` interface from the RPC schema. Mostly a
/// wrapper around an `EndPoint` object. Whereas the `EndPoints` are long-lived
/// (associate with the RTL endpoint), this class is constructed/destructed when
/// the client open()s it.
class EndPointServer
    : public EsiDpiEndpoint<capnp::AnyPointer, capnp::AnyPointer>::Server {
  /// The wrapped endpoint.
  EndPoint *_EndPoint;
  /// Signals that this endpoint has been opened by a client and hasn't been
  /// closed by said client.
  bool _Open;

public:
  EndPointServer(EndPoint *ep) : _EndPoint(ep), _Open(true) {}

  virtual ~EndPointServer() {
    if (_Open)
      _EndPoint->ReturnForUse();
  }

  EndPoint *GetEndPoint() { return _EndPoint; }

  kj::Promise<void> send(SendContext);
  kj::Promise<void> recv(RecvContext);
  kj::Promise<void> close(CloseContext);
};

/// Implements the `CosimDpiServer` interface from the RPC schema.
class CosimServer : public CosimDpiServer::Server {
  /// The registry of endpoints.
  EndPointRegistry *_Reg;

public:
  CosimServer(EndPointRegistry *reg) : _Reg(reg) {}
  virtual ~CosimServer() {}

  /// List all the registered interfaces.
  kj::Promise<void> list(ListContext ctxt);
  /// Open a specific interface, locking it in the process.
  kj::Promise<void> open(OpenContext ctxt);
};

/// The main RpcServer. Does not implement any capnp RPC interfaces but contains
/// the capnp main RPC server. We run the capnp server in its own thread to be
/// more responsive to network traffic and so we do not have to reason about
/// interactions between the capnp (really libkj) async model.
class RpcServer {
public:
  EndPointRegistry EndPoints;

  RpcServer() : _RpcServer(nullptr), _MainThread(nullptr), _Stop(false) {}
  ~RpcServer();

  void Run(uint16_t port);
  void Stop();

private:
  void MainLoop(uint16_t port);

  capnp::EzRpcServer *_RpcServer;
  std::thread *_MainThread;
  volatile bool _Stop;
};

} // namespace cosim
} // namespace esi
} // namespace circt

#endif
