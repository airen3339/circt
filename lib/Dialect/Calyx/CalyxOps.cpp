//===- CalyxOps.cpp - Calyx op code defs ------------------------*- C++ -*-===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//
//
// This is where op definitions live.
//
//===----------------------------------------------------------------------===//

#include "circt/Dialect/Calyx/CalyxOps.h"
#include "mlir/IR/Builders.h"
#include "mlir/IR/BuiltinTypes.h"
#include "mlir/IR/Diagnostics.h"
#include "mlir/IR/DialectImplementation.h"
#include "mlir/IR/FunctionImplementation.h"
#include "mlir/IR/PatternMatch.h"
#include "llvm/ADT/DenseMap.h"
#include "llvm/ADT/STLExtras.h"
#include "llvm/ADT/StringExtras.h"
#include "llvm/ADT/TypeSwitch.h"

using namespace circt;
using namespace circt::calyx;
using namespace mlir;

/// Prints the name and width for Calyx component input and output ports.
/// For example, with given dictionary ["p1": 32, "p2": 64]:
///
/// ```
/// p1: 32, p2: 64
/// ```
void printComponentPortNameAndWidth(OpAsmPrinter &p, DictionaryAttr &nameToWidth) {
  for (auto i = nameToWidth.begin(), e = nameToWidth.end(); i < e; ++i) {
    p << i->first << ": ";
    if (auto integerValue = i->second.dyn_cast<IntegerAttr>())
      p << integerValue.getValue();

    if (i + 1 != e)
      p << ", ";
  }
}

//===----------------------------------------------------------------------===//
// ComponentOp
//===----------------------------------------------------------------------===//

static void printComponentOp(OpAsmPrinter &p, ComponentOp &op) {
  auto name = op->getAttrOfType<SymbolRefAttr>("name");
  p << "component " << name << "(";

  auto inPortNameAndWidth = op->getAttrOfType<DictionaryAttr>("inPortToWidth");
  if (inPortNameAndWidth)
    printComponentPortNameAndWidth(p, inPortNameAndWidth);

  p << ") -> (";

  auto outPortNameAndWidth = op->getAttrOfType<DictionaryAttr>("outPortToWidth");
  if (outPortNameAndWidth)
    printComponentPortNameAndWidth(p, outPortNameAndWidth);

  // TODO(calyx): print cells, wires and control.
  p << ") {}";
}

static ParseResult parseComponentOp(OpAsmParser &parser,
                                    OperationState &result) {
  SymbolRefAttr name;
  DictionaryAttr inPorts, outPorts;
  if (parser.parseAttribute(name, "name", result.attributes) || parser.parseLParen()
      || parser.parseAttribute(inPorts, "inPortToWidth", result.attributes)
      || parser.parseRParen() || parser.parseArrow() || parser.parseLParen()
      || parser.parseAttribute(outPorts, "outPortToWidth", result.attributes)
      || parser.parseRParen() || parser.parseLBrace() || parser.parseRBrace())
    return failure();

  return success();
}

//===----------------------------------------------------------------------===//
// TableGen generated logic.
//===----------------------------------------------------------------------===//

// Provide the autogenerated implementation guts for the Op classes.
#define GET_OP_CLASSES
#include "circt/Dialect/Calyx/Calyx.cpp.inc"
