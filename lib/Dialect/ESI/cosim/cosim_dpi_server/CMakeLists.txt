if(ESI_COSIM)
  find_package(CapnProto CONFIG PATHS "${CMAKE_SOURCE_DIR}/ext")
  add_library(EsiCosimDpiServer SHARED
    DpiEntryPoints.cpp
    Server.cpp
    Endpoint.cpp)

  set_target_properties(EsiCosimDpiServer
      PROPERTIES
          LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib
          RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib
  )
  add_dependencies(EsiCosimDpiServer EsiCosimCapnp MtiPli)
  target_link_libraries(EsiCosimDpiServer PRIVATE
      CapnProto::kj CapnProto::kj-async CapnProto::kj-gzip
      CapnProto::capnp CapnProto::capnp-rpc 
      MtiPli EsiCosimCapnp)

  target_include_directories(EsiCosimDpiServer PRIVATE ${CAPNPC_OUTPUT_DIR})
  target_include_directories(EsiCosimDpiServer PRIVATE ${CAPNP_INCLUDE_DIRS})
  target_include_directories(EsiCosimDpiServer PRIVATE ${CIRCT_INCLUDE_DIR})
endif()
